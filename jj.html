<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAiP23GvWXvOaLNcrGNGPTLVKdMSHM_3Po",
    authDomain: "nktati.firebaseapp.com",
    projectId: "nktati",
    storageBucket: "nktati.appspot.com",
    messagingSenderId: "557364979891",
    appId: "1:557364979891:web:f458d39cb67547a723e8c6",
    measurementId: "G-47VGPGTET6"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<title>نقطتي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <style>
        /* الخطوط */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        /* الأنماط الأساسية */
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background: url('Untitled_logo_1_free-file.jpg') no-repeat center center fixed; /* صورة الخلفية */
            background-size: cover;
            background-position: center;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
            /* لون نص افتراضي ليكون واضحًا على الخلفية */
            transition: background-color 0.3s, color 0.3s;
            /* انتقال سلس للألوان */
        }
        .container {
            max-width: 650px;
            /* تكبير واجهة المستخدم */
            width: 95%;
            margin: 20px auto 80px auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            /* ظل أوضح */
            text-align: center;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 25px; /* مسافات أكبر */
            font-size: 2em;
            /* حجم أكبر للعناوين */
            transition: color 0.3s;
        }
        h2 { font-size: 1.8em;
        }
        h3 { font-size: 1.5em;
        }

        input, select, textarea {
            margin: 12px 0;
            /* مسافات أكبر */
            padding: 12px;
            /* حشوة أكبر */
            width: 90%;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 1.1em; /* حجم خط أكبر */
            box-sizing: border-box;
            background-color: #fff; /* خلفية افتراضية للمدخلات */
            color: #333;
            /* لون نص افتراضي للمدخلات */
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        input:disabled, button:disabled {
            background-color: #eeeeee;
            cursor: not-allowed;
        }
        .password-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 90%;
            margin: 12px auto;
        }
        .password-toggle input {
            flex-grow: 1;
            margin-right: 5px;
        }
        .password-toggle button {
            width: auto;
            padding: 10px;
            margin: 0;
            border-radius: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 25px; /* حشوة أكبر للأزرار */
            margin: 10px 8px;
            /* مسافة أكبر بين الأزرار */
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, color 0.3s; /* إضافة انتقال للألوان */
            font-size: 1.1em;
            /* حجم خط أكبر */
            box-sizing: border-box;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px); /* تأثير خفيف عند التحويم */
        }
        button:active {
            transform: translateY(0);
            /* إلغاء التأثير عند النقر */
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.success {
            background-color: #27ae60;
            font-weight: bold; /* جعل الخط أوضح هنا */
        }
        button.success:hover {
            background-color: #229954;
        }
        button.toggle-admin {
            background-color: #f39c12;
        }
        button.toggle-admin:hover {
            background-color: #e67e22;
        }
        button.convert-sar {
            background-color: #1abc9c;
        }
        button.convert-sar:hover {
            background-color: #16a085;
        }
        button.complete-task { /* زر إنجاز المهمة */
            background-color: #8e44ad;
        }
        button.complete-task:hover {
            background-color: #9b59b6;
        }
        button.clear-notifications { /* زر مسح الإشعارات */
            background-color: #6c757d;
        }
        button.clear-notifications:hover {
            background-color: #5a6268;
        }


        .hidden {
            display: none;
        }
        .error {
            color: #e74c3c;
            margin: 10px 0;
            min-height: 20px;
            font-weight: 700; /* خط سميك */
            transition: opacity 0.4s ease, color 0.3s;
        }
        .success {
            color: #27ae60;
            margin: 10px 0;
            min-height: 20px;
            font-weight: 700;
            transition: opacity 0.4s ease, color 0.3s;
        }
        footer {
            background-color: rgba(255, 255, 255, 0.85);
            text-align: center;
            padding: 15px;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 0.9em;
            /* حجم خط أصغر للفوتر */
            color: #2c3e50;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); /* ظل خفيف لأعلى */
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }
        #historyList, #adminUsersList, #adminNotificationsList, #tasksList, #adminTasksList, #adminRequestsList, #adminSarSettings, #editTaskSection, #userNotificationsList { /* إزالة chatSection */
            text-align: right;
            margin-top: 25px;
            max-height: 250px; /* تكبير ارتفاع القوائم */
            overflow-y: auto;
            background: #f8f8f8;
            padding: 15px; /* حشوة أكبر */
            border-radius: 12px;
            /* زوايا مدورة أكثر */
            font-size: 1em;
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.05); /* ظل داخلي خفيف */
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        ul {
            padding-inline-start: 20px;
            text-align: right;
            margin: 0;
        }
        #adminUsersList ul, #adminNotificationsList ul, #tasksList ul, #adminTasksList ul, #adminRequestsList ul, #userNotificationsList ul { /* إزالة chatSection */
            list-style: none;
            padding: 0;
        }
        #adminUsersList li, #adminNotificationsList li, #tasksList li, #adminTasksList li, #adminRequestsList li, #userNotificationsList li { /* إزالة chatSection */
            background-color: #fff;
            margin-bottom: 10px; /* مسافات أكبر بين العناصر */
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* ظل أوضح */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px; /* مسافة أكبر بين العناصر الداخلية */
            text-align: right;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        #adminUsersList li div, #adminTasksList li div, #adminRequestsList li div, #adminNotificationsList li div { /* تعديل محاذاة الأزرار في القوائم */
            width: 100%;
            display: flex;
            justify-content: flex-end; /* لدفع الأزرار لليسار داخل الليست */
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px; /* مسافة بين المحتوى والأزرار */
        }
        #adminUsersList li button, #adminTasksList li button, #adminRequestsList li button, #adminNotificationsList li button {
            margin: 0 2px;
            padding: 8px 15px; /* حشوة أكبر للأزرار داخل القوائم */
            font-size: 0.9em;
            flex-shrink: 0;
        }
        #adminUsersList li input {
            width: 100px;
            /* حجم أصغر لحقل النقاط */
            margin: 0 5px 0 0;
            /* مسافة على اليمين */
            padding: 8px;
            font-size: 0.9em;
        }
        .task-timer { /* سيتم استخدامه داخل كل مهمة الآن */
            font-size: 0.9em;
            color: #c0392b;
            font-weight: bold;
            margin-top: 10px;
            text-align: center; /* توسيط العداد */
            transition: color 0.3s;
        }
        .task-buttons {
            display: flex;
            justify-content: flex-end; /* الأزرار على اليسار */
            width: 100%;
            gap: 5px;
            margin-top: 10px;
        }
        .task-points {
            font-size: 0.9em;
            color: #27ae60;
            font-weight: bold;
            transition: color 0.3s;
        }
        .request-status {
            font-weight: bold;
            color: #f39c12; /* لون برتقالي لحالة معلق */
            transition: color 0.3s;
        }
        .notification-status-approved {
            color: #27ae60;
            font-weight: bold;
        }
        .notification-status-rejected {
            color: #e74c3c;
            font-weight: bold;
        }
        .notification-status-deletion { /* حالة لطلب الحذف */
            color: #3498db;
            font-weight: bold;
        }
        #adminSarSettings p {
            font-size: 1.1em;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 15px;
            transition: color 0.3s;
        }
        #adminSarSettings input {
            width: calc(90% - 120px);
            /* حجم مناسب مع الزر */
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        #adminSarSettings button {
            width: auto;
            display: inline-block;
            vertical-align: middle;
        }
        #editTaskSection {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            background-color: #f0f8ff;
            margin-top: 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #editTaskSection h3 {
            margin-top: 0;
            color: #3498db;
        }
        #editTaskSection input,
        #editTaskSection textarea,
        #editTaskSection select {
            width: calc(100% - 24px);
            /* لكي لا يتجاوز الحدود مع البادينغ */
        }

        /* زر تبديل الوضع */
        #darkModeToggle {
            position: fixed;
            top: 20px;
            left: 20px; /* وضعه في الزاوية اليسرى العلوية */
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #darkModeToggle:hover {
            background-color: #5a6268;
            transform: scale(1.05);
        }

        /* زر الرجوع الجديد */
        #backButton {
            position: fixed;
            top: 20px;
            right: 20px; /* وضعه في الزاوية اليمنى العلوية */
            background-color: #3498db;
            color: white;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #backButton:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        /* أنماط زر خدمة العملاء في الفوتر */
        #customerServiceButton {
            background-color: #4CAF50;
            /* لون أخضر جميل */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px;
            /* لإعطاء مسافة من باقي الفوتر */
            min-width: 150px;
            /* لتوسيع الزر قليلاً */
        }
        #customerServiceButton:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        /* أنماط المودال (النافذة المنبثقة) */
        .modal {
            display: none;
            /* مخفي افتراضياً */
            position: fixed;
            /* يبقى في مكانه حتى عند التمرير */
            z-index: 1001;
            /* يظهر فوق كل شيء آخر */
            left: 0;
            top: 0;
            width: 100%; /* عرض كامل */
            height: 100%;
            /* ارتفاع كامل */
            overflow: auto;
            /* تمكين التمرير إذا كان المحتوى كبيرًا */
            background-color: rgba(0,0,0,0.6);
            /* خلفية سوداء شبه شفافة */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%; /* عرض المودال */
            max-width: 500px;
            /* زيادة عرض المودال لخدمة العملاء */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            text-align: center;
            color: #333;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6em;
        }

        .modal-content p {
            margin: 10px 0;
            font-size: 1.1em;
            display: flex; /* لترتيب الأيقونات والنص */
            align-items: center;
            justify-content: center; /* توسيط المحتوى */
            gap: 10px;
            /* مسافة بين الأيقونة والنص */
        }
        .modal-content p i { /* أنماط الأيقونات */
            font-size: 1.3em;
            color: #3498db;
        }
        .modal-content p .phone-number { /* لجعل رقم الهاتف قابل للنسخ */
            user-select: all;
            /* يسمح بتحديد النص بالكامل بسهولة */
            cursor: pointer;
            text-decoration: underline;
        }


        .modal-content a {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        .modal-content a:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            left: 20px;
            /* الزاوية اليسرى العلوية */
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }


        /* أنماط الوضع الداكن */
        body.dark-mode {
            background-color: #1a1a1a;
            /* خلفية داكنة */
            background-image: none;
            /* إزالة صورة الخلفية في الوضع الداكن */
            color: #f5f5f5;
            /* لون نص فاتح */
        }
        body.dark-mode .container {
            background-color: rgba(45, 45, 45, 0.95);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3 {
            color: #e0e0e0;
        }
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #333;
            color: #f5f5f5;
            border-color: #555;
        }
        body.dark-mode input:disabled, body.dark-mode button:disabled {
            background-color: #252525;
            color: #777;
        }
        body.dark-mode button {
            background-color: #555;
            /* أزرار داكنة */
            color: #f5f5f5;
        }
        body.dark-mode button:hover {
            background-color: #666;
        }
        body.dark-mode button.danger {
            background-color: #c0392b;
        }
        body.dark-mode button.danger:hover {
            background-color: #a0291b;
        }
        body.dark-mode button.success {
            background-color: #229954;
        }
        body.dark-mode button.success:hover {
            background-color: #1d7b42;
        }
        body.dark-mode button.toggle-admin {
            background-color: #e67e22;
        }
        body.dark-mode button.toggle-admin:hover {
            background-color: #d35400;
        }
        body.dark-mode button.complete-task {
            background-color: #9b59b6;
        }
        body.dark-mode button.complete-task:hover {
            background-color: #8e44ad;
        }
        body.dark-mode button.clear-notifications {
            background-color: #5a6268;
        }
        body.dark-mode button.clear-notifications:hover {
            background-color: #4b5257;
        }

        body.dark-mode footer {
            background-color: rgba(30, 30, 30, 0.85);
            color: #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }
        body.dark-mode #historyList,
        body.dark-mode #adminUsersList,
        body.dark-mode #adminNotificationsList,
        body.dark-mode #tasksList,
        body.dark-mode #adminTasksList,
        body.dark-mode #adminRequestsList,
        body.dark-mode #adminSarSettings,
        body.dark-mode #editTaskSection,
        body.dark-mode #userNotificationsList { /* إزالة chatSection */
            background: #2a2a2a;
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.2);
        }
        body.dark-mode #adminUsersList li,
        body.dark-mode #adminNotificationsList li,
        body.dark-mode #tasksList li,
        body.dark-mode #adminTasksList li,
        body.dark-mode #adminRequestsList li,
        body.dark-mode #userNotificationsList li { /* إزالة chatSection */
            background-color: #383838;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        body.dark-mode .task-timer,
        body.dark-mode .error {
            color: #ff7675;
            /* لون مختلف لعداد الوقت والأخطاء في الوضع الداكن */
        }
        body.dark-mode .success,
        body.dark-mode .task-points,
        body.dark-mode .notification-status-approved {
            color: #7bed9f;
            /* لون مختلف للنجاح والنقاط في الوضع الداكن */
        }
        body.dark-mode .request-status,
        body.dark-mode .notification-status-rejected {
            color: #ffeaa7;
            /* لون مختلف لحالة الطلب في الوضع الداكن */
        }
        body.dark-mode .notification-status-deletion {
            color: #8be0ff;
            /* لون مختلف لطلب الحذف في الوضع الداكن */
        }
        body.dark-mode #adminSarSettings p {
            color: #b2bec3;
        }
        body.dark-mode #editTaskSection {
            background-color: #2e3b4e;
            border-color: #4a6c8e;
        }
        body.dark-mode #editTaskSection h3 {
            color: #8be0ff;
        }
        body.dark-mode a {
            color: #a0c4ff;
            /* لون الروابط في الوضع الداكن */
        }
        body.dark-mode a:hover {
            color: #7b9eff;
        }
        body.dark-mode #backButton {
            background-color: #4a6c8e;
            color: #e0e0e0;
        }
        body.dark-mode #backButton:hover {
            background-color: #5a82a6;
        }
        /* أنماط المودال في الوضع الداكن */
        body.dark-mode .modal-content {
            background-color: #383838;
            color: #f5f5f5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
        }
        body.dark-mode .modal-content h3 {
            color: #e0e0e0;
        }
        body.dark-mode .modal-content a {
            color: #8be0ff;
        }
        body.dark-mode .modal-content a:hover {
            color: #6fb0e0;
        }
        body.dark-mode .modal-content p i { /* أيقونات المودال في الوضع الداكن */
            color: #8be0ff;
        }
        body.dark-mode .close-button {
            color: #bbb;
        }
        body.dark-mode .close-button:hover,
        body.dark-mode .close-button:focus {
            color: #f5f5f5;
        }
        body.dark-mode #customerServiceButton {
            background-color: #388e3c;
        }
        body.dark-mode #customerServiceButton:hover {
            background-color: #2e7d32;
        }
        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 20px 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.5em;
            }
            h3 {
                font-size: 1.3em;
            }
            input, select, textarea {
                width: 100%;
                font-size: 1em;
                padding: 10px;
            }
            .password-toggle {
                width: 100%;
            }
            button {
                width: 48%;
                margin: 5px 1%;
                padding: 10px 15px;
                font-size: 1em;
            }
            #adminUsersList li div, #adminTasksList li div, #adminRequestsList li div, #adminNotificationsList li div {
                flex-direction: column;
                align-items: stretch;
            }
            #adminUsersList li button, #adminTasksList li button, #adminRequestsList li button, #adminNotificationsList li button {
                width: 100%;
                margin: 2px 0;
            }
            #adminUsersList li input {
                width: 100%;
                margin: 5px 0;
            }
            #adminSarSettings input, #adminSarSettings button {
                width: 100%;
                display: block;
                margin: 5px 0;
            }
            #editTaskSection input, #editTaskSection textarea, #editTaskSection select {
                width: 100%;
            }
            #darkModeToggle {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.3em;
            }
            #backButton {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.9em;
            }
            .modal-content {
                width: 90%;
                padding: 20px;
            }
            .close-button {
                font-size: 24px;
                top: 5px;
                left: 15px;
            }
        }
    </style>
</head>
<body>
<button id="darkModeToggle" aria-label="تبديل الوضع"></button>
<button id="backButton" class="hidden" onclick="goBack()">رجوع</button>
<div class="container">
    <h1>مرحبًا بك في نقطتي</h1>
    <div id="main">
        <button onclick="showSignup()">إنشاء حساب</button>
        <button onclick="showLogin()">تسجيل الدخول</button>
        <button onclick="showForgotPassword()">نسيت كلمة المرور؟</button>
    </div>
    <div id="signup" class="hidden">
        <h2>إنشاء حساب</h2>
        <input id="signupEmail" type="email" placeholder="البريد الإلكتروني" required />
        <div class="password-toggle">
            <input id="signupPassword" type="password" placeholder="كلمة المرور" required />
            <button type="button" onclick="togglePasswordVisibility('signupPassword')"><i class="fas fa-eye"></i></button>
        </div>
        <div class="password-toggle">
            <input id="signupPasswordConfirm" type="password" placeholder="تأكيد كلمة المرور" required />
            <button type="button" onclick="togglePasswordVisibility('signupPasswordConfirm')"><i class="fas fa-eye"></i></button>
        </div>
        <input id="signupUsername" placeholder="اسم المستخدم" required />
        <div id="signupError" class="error"></div>
        <div id="signupSuccess" class="success"></div>
        <button onclick="createAccount()">إنشاء</button>
    </div>
    <div id="login" class="hidden">
        <h2>تسجيل الدخول</h2>
        <input id="loginIdentifier" type="text" placeholder="اسم المستخدم أو البريد الإلكتروني" required />
        <div class="password-toggle">
            <input id="loginPassword" type="password" placeholder="كلمة المرور" required />
            <button type="button" onclick="togglePasswordVisibility('loginPassword')"><i class="fas fa-eye"></i></button>
        </div>
        <div id="loginError" class="error"></div>
        <button onclick="loginUser()">دخول</button>
    </div>
    <div id="forgotPassword" class="hidden">
        <h2>نسيت كلمة المرور</h2>
        <div id="forgotEmailSection">
            <p style="font-size: 0.9em; color: #555;">أدخل بريدك الإلكتروني لطلب كود إعادة التعيين من المسؤول.</p>
            <input id="forgotEmail" type="email" placeholder="البريد الإلكتروني" required />
            <div id="forgotError" class="error"></div>
            <div id="forgotSuccess" class="success"></div>
            <button onclick="resetPassword()">طلب الكود</button>
        </div>
        <div id="forgotCodeSection" class="hidden">
            <p style="font-size: 0.9em; color: #555;">تم إرسال طلب للمسؤول. أدخل الكود الذي تستلمه منه للمتابعة.</p>
            <input id="forgotCode" type="text" placeholder="أدخل الكود" required />
            <div id="forgotCodeError" class="error"></div>
            <button onclick="verifyForgotPasswordCode()">تحقق من الكود</button>
        </div>
        <div id="forgotNewPasswordSection" class="hidden">
            <h3>تعيين كلمة مرور جديدة</h3>
            <input id="resetNewPassword" type="password" placeholder="كلمة المرور الجديدة" />
            <input id="resetNewPasswordConfirm" type="password" placeholder="تأكيد كلمة المرور الجديدة" />
            <div id="resetNewPasswordError" class="error"></div>
            <div id="resetNewPasswordSuccess" class="success"></div>
            <button onclick="performPasswordReset()"></button>
        </div>
    </div>

    <div id="dashboard" class="box hidden">
        <h2>لوحة التحكم</h2>
        <p>مرحباً بك، <span id="usernameDisplay"></span>!</p>
        <p>النقاط: <span id="userPoints">0</span></p>
        <button onclick="showAdminSection()" id="adminButton" class="toggle-admin hidden">إدارة</button>
        <button onclick="showTasks()">المهام</button>
        <button onclick="showHistory()">سجل النقاط</button>
        <button onclick="showNotifications()">الإشعارات <span id="notificationCount" class="hidden"></span></button>
        <button onclick="showLoan()">طلب استلاف</button>
        <button onclick="requestAccountDeletion()" class="danger">طلب حذف حساب</button>
        <button onclick="logout()">تسجيل الخروج</button>
    </div>

    <div id="adminSection" class="box hidden">
        <h2>إدارة النظام</h2>
        <button onclick="showAdminUsers()">إدارة المستخدمين</button>
        <button onclick="showAddPoints()">إضافة نقاط</button>
        <button onclick="showTransferPoints()">تحويل نقاط</button>
        <button onclick="showAdminTasks()">إدارة المهام</button>
        <button onclick="showAdminRequests()">طلبات تغيير كلمة المرور</button>
        <button onclick="showAdminNotifications()">إدارة الإشعارات</button>
        <button onclick="showAdminSARSettings()">إعدادات التحويل لـ SAR</button>
        <button onclick="showViolationsAdmin()">إدارة المخالفات</button>
        <button onclick="backToDashboard()">رجوع</button>
    </div>

    <div id="addPoints" class="box hidden">
        <h2>إضافة نقاط</h2>
        <input id="addPointsUsername" type="text" placeholder="اسم المستخدم" />
        <input id="pointsToAdd" type="number" placeholder="عدد النقاط" />
        <div id="addPointsError" class="error"></div>
        <div id="addPointsSuccess" class="success"></div>
        <button onclick="addPoints()">إضافة</button>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="transferPoints" class="box hidden">
        <h2>تحويل نقاط</h2>
        <input id="transferToUsername" type="text" placeholder="المستلم" />
        <input id="pointsToTransfer" type="number" placeholder="عدد النقاط" />
        <div id="transferError" class="error"></div>
        <div id="transferSuccess" class="success"></div>
        <button onclick="transferPoints()">تحويل</button>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="history" class="box hidden">
        <h2>سجل النقاط</h2>
        <div id="historyList">جاري التحميل...</div>
        <button onclick="backToDashboard()">رجوع</button>
    </div>

    <div id="adminUsers" class="box hidden">
        <h2>إدارة المستخدمين</h2>
        <div id="adminUsersList">جاري التحميل...</div>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="tasks" class="box hidden">
        <h2>المهام</h2>
        <div id="tasksList">جاري التحميل...</div>
        <button onclick="backToDashboard()">رجوع</button>
    </div>

    <div id="adminTasks" class="box hidden">
        <h2>إدارة المهام</h2>
        <input type="text" id="taskTitle" placeholder="عنوان المهمة" />
        <textarea id="taskDesc" placeholder="شرح المهمة"></textarea>
        <input type="number" id="taskPoints" placeholder="النقاط" />
        <input type="text" id="taskDueDate" placeholder="تاريخ الانتهاء (اختياري: YYYY-MM-DD)" />
        <input type="text" id="taskAssignee" placeholder="المسؤول (اسم المستخدم، اختياري)" />
        <button onclick="addTask()">إضافة مهمة</button>
        <div id="adminTasksList">جاري التحميل...</div>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="editTaskSection" class="box hidden">
        <h3>تعديل المهمة</h3>
        <input type="hidden" id="editTaskId">
        <input type="text" id="editTaskTitle" placeholder="عنوان المهمة" />
        <textarea id="editTaskDesc" placeholder="شرح المهمة"></textarea>
        <input type="number" id="editTaskPoints" placeholder="النقاط" />
        <input type="text" id="editTaskDueDate" placeholder="تاريخ الانتهاء (YYYY-MM-DD)" />
        <input type="text" id="editTaskAssignee" placeholder="المسؤول (اسم المستخدم)" />
        <select id="editTaskStatus">
            <option value="pending">قيد الانتظار</option>
            <option value="completed">مكتملة</option>
            <option value="rejected">مرفوضة</option>
        </select>
        <button onclick="saveTaskChanges()">حفظ التغييرات</button>
        <button onclick="cancelEditTask()">إلغاء</button>
    </div>

    <div id="adminRequests" class="box hidden">
        <h2>طلبات تغيير كلمة المرور</h2>
        <div id="adminRequestsList">جاري التحميل...</div>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="notifications" class="box hidden">
        <h2>إشعاراتي</h2>
        <div id="userNotificationsList">جاري التحميل...</div>
        <button onclick="clearAllNotifications()" class="clear-notifications">مسح كل الإشعارات</button>
        <button onclick="backToDashboard()">رجوع</button>
    </div>

    <div id="adminNotifications" class="box hidden">
        <h2>إدارة الإشعارات</h2>
        <div id="adminNotificationsList">جاري التحميل...</div>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="adminSarSettings" class="box hidden">
        <h2>إعدادات التحويل لـ SAR</h2>
        <p>سعر تحويل النقطة الواحدة إلى SAR: <span id="currentSarRate"></span></p>
        <input type="number" id="newSarRate" placeholder="سعر جديد لكل نقطة" step="0.01" />
        <button onclick="updateSarRate()">تحديث</button>
        <br><br>
        <input type="number" id="pointsToConvert" placeholder="عدد النقاط للتحويل" />
        <button onclick="convertPointsToSar()" class="convert-sar">تحويل إلى SAR</button>
        <p>القيمة المحولة: <span id="convertedSarValue">0.00 SAR</span></p>
        <button onclick="backToAdmin()">رجوع</button>
    </div>

    <div id="violationsAdmin" class="box" style="display:none;">
        <h3>إدارة المخالفات</h3>
        <input type="text" id="violationUser" placeholder="اسم المستخدم">
        <input type="text" id="violationTitle" placeholder="عنوان المخالفة">
        <input type="text" id="violationDesc" placeholder="شرح المخالفة">
        <input type="number" id="violationPoints" placeholder="عدد النقاط">
        <input type="text" id="violationDue" placeholder="مدة السداد (مثلاً: 3 أيام)">
        <button onclick="addViolation()">إضافة مخالفة</button>
        <div id="violationListAdmin"></div>
        <br><button onclick="backToDashboard()">رجوع</button>
    </div>

    <div id="violationsUser" class="box" style="display:none;">
        <h3>مخالفاتي</h3>
        <div id="violationListUser">جاري التحميل...</div>
        <br><button onclick="backToDashboard()">رجوع</button>
    </div>

    <div id="loanSection" class="box" style="display:none;">
        <h3>طلب استلاف</h3>
        <input type="text" id="loanFrom" placeholder="اسم المستخدم المراد الاستلاف منه">
        <input type="number" id="loanAmount" placeholder="عدد النقاط">
        <button onclick="sendLoanRequest()">إرسال الطلب</button>
        <h4>طلبات الاستلاف الواردة</h4>
        <div id="loanRequests">جاري التحميل...</div>
        <br><button onclick="backToDashboard()">رجوع</button>
    </div>

</div>

<div id="customerServiceModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeCustomerServiceModal()">&times;</span>
        <h3>خدمة العملاء</h3>
        <p><i class="fas fa-phone"></i> الهاتف: <span class="phone-number" onclick="copyPhoneNumber('+966500000000')">+966500000000</span></p>
        <p><i class="fab fa-whatsapp"></i> واتساب: <a href="https://wa.me/966500000000" target="_blank">+966500000000</a></p>
        <p><i class="fas fa-envelope"></i> البريد الإلكتروني: <a href="mailto:support@noktati.com">support@noktati.com</a></p>
        <p><i class="fab fa-twitter"></i> تويتر (X): <a href="https://twitter.com/noktati_app" target="_blank">@noktati_app</a></p>
    </div>
</div>


<footer>
    &copy; 2025 نقطتي. كل الحقوق محفوظة.
    <button id="customerServiceButton" onclick="openCustomerServiceModal()">خدمة العملاء</button>
</footer>

<script>
    let currentUser;
    let users = {}; // A local cache for user data, indexed by username
    let notifications = [];
    let adminNotifications = [];
    let sarRate = 0.01; // Default SAR conversion rate

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        checkLoginStatus();

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        if (savedDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>'; // Sun icon for light mode
        } else {
            darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>'; // Moon icon for dark mode
        }

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });
    });

    async function loadData() {
        try {
            const usersSnapshot = await db.collection("users").get();
            users = {}; // Clear existing cache
            usersSnapshot.forEach(doc => {
                users[doc.data().username] = { ...doc.data(), id: doc.id };
            });

            const sarDoc = await db.collection("settings").doc("sarConversion").get();
            if (sarDoc.exists) {
                sarRate = sarDoc.data().rate;
                document.getElementById("currentSarRate").textContent = sarRate.toFixed(2);
            }
        } catch (error) {
            console.error("Error loading initial data:", error);
        }
    }

    // Function to save user data (for mock database) - not strictly needed with Firestore
    function saveData() {
        // No explicit save needed for Firestore, changes are direct
    }

    function showSection(id) {
        document.querySelectorAll('.box, #main, #signup, #login, #forgotPassword').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('backButton').classList.add('hidden'); // Hide by default
    }

    function showMain() {
        showSection('main');
    }

    function showSignup() {
        showSection('signup');
        document.getElementById('signupEmail').value = '';
        document.getElementById('signupPassword').value = '';
        document.getElementById('signupPasswordConfirm').value = '';
        document.getElementById('signupUsername').value = '';
        document.getElementById('signupError').textContent = '';
        document.getElementById('signupSuccess').textContent = '';
        document.getElementById('backButton').classList.remove('hidden');
    }

    function showLogin() {
        showSection('login');
        document.getElementById('loginIdentifier').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginError').textContent = '';
        document.getElementById('backButton').classList.remove('hidden');
    }

    function showForgotPassword() {
        showSection('forgotPassword');
        document.getElementById('forgotEmail').value = '';
        document.getElementById('forgotError').textContent = '';
        document.getElementById('forgotSuccess').textContent = '';
        document.getElementById('forgotCode').value = '';
        document.getElementById('forgotCodeError').textContent = '';
        document.getElementById('resetNewPassword').value = '';
        document.getElementById('resetNewPasswordConfirm').value = '';
        document.getElementById('resetNewPasswordError').textContent = '';
        document.getElementById('resetNewPasswordSuccess').textContent = '';
        document.getElementById('forgotEmailSection').classList.remove('hidden');
        document.getElementById('forgotCodeSection').classList.add('hidden');
        document.getElementById('forgotNewPasswordSection').classList.add('hidden');
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function createAccount() {
        const email = document.getElementById("signupEmail").value.trim();
        const password = document.getElementById("signupPassword").value;
        const confirmPassword = document.getElementById("signupPasswordConfirm").value;
        const username = document.getElementById("signupUsername").value.trim();
        const signupError = document.getElementById("signupError");
        const signupSuccess = document.getElementById("signupSuccess");

        signupError.textContent = "";
        signupSuccess.textContent = "";

        if (password !== confirmPassword) {
            signupError.textContent = "كلمة المرور وتأكيدها غير متطابقين.";
            return;
        }
        if (password.length < 6) {
            signupError.textContent = "يجب أن تكون كلمة المرور 6 أحرف على الأقل.";
            return;
        }
        if (!username) {
            signupError.textContent = "اسم المستخدم مطلوب.";
            return;
        }

        try {
            // Check if username already exists
            const usernameSnapshot = await db.collection("users").where("username", "==", username).get();
            if (!usernameSnapshot.empty) {
                signupError.textContent = "اسم المستخدم هذا موجود بالفعل.";
                return;
            }

            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            await db.collection("users").doc(user.uid).set({
                email: email,
                username: username,
                points: 0,
                isAdmin: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            signupSuccess.textContent = "تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول.";
            // Optionally, clear fields or redirect to login after success
            document.getElementById("signupEmail").value = "";
            document.getElementById("signupPassword").value = "";
            document.getElementById("signupPasswordConfirm").value = "";
            document.getElementById("signupUsername").value = "";
        } catch (error) {
            console.error("Error creating account:", error);
            signupError.textContent = `فشل إنشاء الحساب: ${error.message}`;
        }
    }

    async function loginUser() {
        const identifier = document.getElementById("loginIdentifier").value.trim();
        const password = document.getElementById("loginPassword").value;
        const loginError = document.getElementById("loginError");

        loginError.textContent = "";

        try {
            let email = identifier;
            // Check if identifier is a username
            if (!identifier.includes('@')) {
                const snapshot = await db.collection("users").where("username", "==", identifier).get();
                if (snapshot.empty) {
                    loginError.textContent = "اسم المستخدم أو البريد الإلكتروني غير صحيح.";
                    return;
                }
                email = snapshot.docs[0].data().email;
            }

            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error("Error logging in:", error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                loginError.textContent = "اسم المستخدم/البريد الإلكتروني أو كلمة المرور غير صحيحة.";
            } else {
                loginError.textContent = `فشل تسجيل الدخول: ${error.message}`;
            }
        }
    }

    async function logout() {
        try {
            await auth.signOut();
            currentUser = null;
            showMain();
            document.getElementById('backButton').classList.add('hidden'); // Hide back button on logout
            console.log("User logged out");
        } catch (error) {
            console.error("Error logging out:", error);
            alert("حدث خطأ أثناء تسجيل الخروج: " + error.message);
        }
    }

    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const userDoc = await db.collection("users").doc(user.uid).get();
            if (userDoc.exists) {
                currentUser = { id: user.uid, ...userDoc.data() };
                document.getElementById("usernameDisplay").textContent = currentUser.username;
                document.getElementById("userPoints").textContent = currentUser.points;

                if (currentUser.isAdmin) {
                    document.getElementById("adminButton").classList.remove("hidden");
                } else {
                    document.getElementById("adminButton").classList.add("hidden");
                }
                showDashboard();
                loadNotifications(); // Load notifications for the logged-in user
                updateNotificationCount();
                document.getElementById('backButton').classList.remove('hidden');
            } else {
                // User document not found, log out or handle error
                console.error("User document not found for UID:", user.uid);
                await auth.signOut();
                showMain();
            }
        } else {
            currentUser = null;
            showMain();
            document.getElementById('backButton').classList.add('hidden');
        }
    });

    function showDashboard() {
        showSection('dashboard');
        if (currentUser) {
            document.getElementById("usernameDisplay").textContent = currentUser.username;
            document.getElementById("userPoints").textContent = currentUser.points;
        }
        document.getElementById('backButton').classList.remove('hidden');
    }

    function showAdminSection() {
        showSection('adminSection');
        document.getElementById('backButton').classList.remove('hidden');
    }

    function backToDashboard() {
        showDashboard();
    }

    function backToAdmin() {
        showAdminSection();
    }

    function showAddPoints() {
        showSection('addPoints');
        document.getElementById('addPointsUsername').value = '';
        document.getElementById('pointsToAdd').value = '';
        document.getElementById('addPointsError').textContent = '';
        document.getElementById('addPointsSuccess').textContent = '';
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function addPoints() {
        const username = document.getElementById("addPointsUsername").value.trim();
        const points = parseInt(document.getElementById("pointsToAdd").value);
        const addPointsError = document.getElementById("addPointsError");
        const addPointsSuccess = document.getElementById("addPointsSuccess");

        addPointsError.textContent = "";
        addPointsSuccess.textContent = "";

        if (!username || isNaN(points) || points <= 0) {
            addPointsError.textContent = "يرجى إدخال اسم مستخدم وعدد نقاط صحيح وموجب.";
            return;
        }

        try {
            const snapshot = await db.collection("users").where("username", "==", username).get();
            if (snapshot.empty) {
                addPointsError.textContent = "المستخدم غير موجود.";
                return;
            }

            const userDoc = snapshot.docs[0];
            const userRef = db.collection("users").doc(userDoc.id);

            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(userRef);
                const currentPoints = doc.data().points || 0;
                const newPoints = currentPoints + points;
                transaction.update(userRef, { points: newPoints });

                // Add to history
                await db.collection("history").add({
                    userId: userDoc.id,
                    username: username,
                    type: "added",
                    amount: points,
                    newBalance: newPoints,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            addPointsSuccess.textContent = `تم إضافة ${points} نقطة للمستخدم ${username} بنجاح.`;
            document.getElementById('pointsToAdd').value = ''; // Clear points input after success
            // Update current user's points if it's them
            if (currentUser && currentUser.username === username) {
                currentUser.points += points;
                document.getElementById("userPoints").textContent = currentUser.points;
            }
        } catch (error) {
            console.error("Error adding points:", error);
            addPointsError.textContent = `فشل إضافة النقاط: ${error.message}`;
        }
    }

    function showTransferPoints() {
        showSection('transferPoints');
        document.getElementById('transferToUsername').value = '';
        document.getElementById('pointsToTransfer').value = '';
        document.getElementById('transferError').textContent = '';
        document.getElementById('transferSuccess').textContent = '';
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function transferPoints() {
        const toUsername = document.getElementById("transferToUsername").value.trim();
        const amount = parseInt(document.getElementById("pointsToTransfer").value);
        const transferError = document.getElementById("transferError");
        const transferSuccess = document.getElementById("transferSuccess");

        transferError.textContent = "";
        transferSuccess.textContent = "";

        if (!toUsername || isNaN(amount) || amount <= 0) {
            transferError.textContent = "يرجى إدخال مستلم وعدد نقاط صحيح وموجب.";
            return;
        }
        if (!currentUser) {
            transferError.textContent = "يجب أن تكون مسجلاً للدخول لتحويل النقاط.";
            return;
        }
        if (currentUser.username === toUsername) {
            transferError.textContent = "لا يمكنك تحويل النقاط لنفسك.";
            return;
        }

        try {
            const fromUserRef = db.collection("users").doc(currentUser.id);
            const toUserSnapshot = await db.collection("users").where("username", "==", toUsername).get();

            if (toUserSnapshot.empty) {
                transferError.textContent = "المستخدم المستلم غير موجود.";
                return;
            }

            const toUserDoc = toUserSnapshot.docs[0];
            const toUserRef = db.collection("users").doc(toUserDoc.id);

            await db.runTransaction(async (transaction) => {
                const fromDoc = await transaction.get(fromUserRef);
                const toDoc = await transaction.get(toUserRef);

                const fromPoints = fromDoc.data().points || 0;
                const toPoints = toDoc.data().points || 0;

                if (fromPoints < amount) {
                    throw new Error("نقاطك لا تكفي لإجراء هذا التحويل.");
                }

                const newFromPoints = fromPoints - amount;
                const newToPoints = toPoints + amount;

                transaction.update(fromUserRef, { points: newFromPoints });
                transaction.update(toUserRef, { points: newToPoints });

                // Add to history for sender
                await db.collection("history").add({
                    userId: currentUser.id,
                    username: currentUser.username,
                    type: "sent",
                    amount: amount,
                    newBalance: newFromPoints,
                    toUser: toUsername,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Add to history for receiver
                await db.collection("history").add({
                    userId: toUserDoc.id,
                    username: toUsername,
                    type: "received",
                    amount: amount,
                    newBalance: newToPoints,
                    fromUser: currentUser.username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Send notification to receiver
                await sendNotification(toUserDoc.id, `${currentUser.username} أرسل لك ${amount} نقطة.`, "points_transfer", newToPoints);
            });

            currentUser.points -= amount; // Update local currentUser object
            document.getElementById("userPoints").textContent = currentUser.points; // Update dashboard display
            transferSuccess.textContent = `تم تحويل ${amount} نقطة إلى ${toUsername} بنجاح.`;
            document.getElementById('pointsToTransfer').value = ''; // Clear points input after success
            document.getElementById('transferToUsername').value = ''; // Clear username input
        } catch (error) {
            console.error("Error transferring points:", error);
            transferError.textContent = `فشل تحويل النقاط: ${error.message}`;
        }
    }

    function showHistory() {
        showSection('history');
        loadHistory();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function loadHistory() {
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = "جاري التحميل...";

        if (!currentUser) {
            historyList.innerHTML = "يرجى تسجيل الدخول لعرض السجل.";
            return;
        }

        try {
            const snapshot = await db.collection("history")
                .where("userId", "==", currentUser.id)
                .orderBy("timestamp", "desc")
                .limit(50) // Limit to recent 50 entries
                .get();

            if (snapshot.empty) {
                historyList.innerHTML = "لا يوجد سجل نقاط.";
                return;
            }

            let html = "<ul>";
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString("ar-EG") : "تاريخ غير متوفر";
                let description = "";

                if (data.type === "added") {
                    description = `تم إضافة ${data.amount} نقطة. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "sent") {
                    description = `أرسلت ${data.amount} نقطة إلى ${data.toUser}. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "received") {
                    description = `استلمت ${data.amount} نقطة من ${data.fromUser}. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "task_completed") {
                    description = `أنجزت مهمة "${data.taskTitle}" وحصلت على ${data.amount} نقطة. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "violation_paid") {
                    description = `قمت بسداد مخالفة "${data.violationTitle}" بمقدار ${data.amount} نقطة. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "violation_deducted") {
                    description = `تم خصم ${data.amount} نقطة بسبب مخالفة "${data.violationTitle}". الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "loan_approved_from") {
                    description = `تمت الموافقة على طلب استلاف من ${data.toUsername} بمقدار ${data.amount} نقطة. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "loan_approved_to") {
                    description = `تمت الموافقة على طلب استلافك من ${data.fromUsername} بمقدار ${data.amount} نقطة. الرصيد الجديد: ${data.newBalance}.`;
                } else if (data.type === "sar_converted") {
                    description = `تم تحويل ${data.amount} نقطة إلى ${data.sarValue.toFixed(2)} SAR. الرصيد الجديد: ${data.newBalance}.`;
                } else {
                    description = `حدث: ${data.type} بمقدار ${data.amount} نقطة. الرصيد الجديد: ${data.newBalance}.`;
                }

                html += `<li><small>${date}</small><br>${description}</li>`;
            });
            html += "</ul>";
            historyList.innerHTML = html;
        } catch (error) {
            console.error("Error loading history:", error);
            historyList.innerHTML = "حدث خطأ أثناء تحميل السجل.";
        }
    }

    function showAdminUsers() {
        showSection('adminUsers');
        loadAdminUsers();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function loadAdminUsers() {
        const adminUsersList = document.getElementById("adminUsersList");
        adminUsersList.innerHTML = "جاري التحميل...";

        try {
            const snapshot = await db.collection("users").orderBy("createdAt", "desc").get();
            if (snapshot.empty) {
                adminUsersList.innerHTML = "لا يوجد مستخدمون.";
                return;
            }

            let html = "<ul>";
            snapshot.forEach(doc => {
                const user = { id: doc.id, ...doc.data() };
                const isAdminChecked = user.isAdmin ? "checked" : "";
                html += `
                    <li>
                        <b>${user.username}</b> (${user.email}) - نقاط: ${user.points}
                        <div>
                            <input type="number" id="points_${user.id}" placeholder="نقاط" value="0" style="width: 80px;">
                            <button onclick="adminAddPointsToUser('${user.id}', '${user.username}')" class="success">إضافة</button>
                            <button onclick="adminDeductPointsFromUser('${user.id}', '${user.username}')" class="danger">خصم</button>
                            <label><input type="checkbox" ${isAdminChecked} onchange="toggleAdminStatus('${user.id}', this.checked)"> مسؤول</label>
                            <button onclick="deleteUser('${user.id}', '${user.username}')" class="danger">حذف</button>
                        </div>
                    </li>
                `;
            });
            html += "</ul>";
            adminUsersList.innerHTML = html;
        } catch (error) {
            console.error("Error loading admin users:", error);
            adminUsersList.innerHTML = "حدث خطأ أثناء تحميل المستخدمين.";
        }
    }

    async function adminAddPointsToUser(userId, username) {
        const pointsInput = document.getElementById(`points_${userId}`);
        const points = parseInt(pointsInput.value);

        if (isNaN(points) || points <= 0) {
            alert("يرجى إدخال عدد نقاط موجب صحيح.");
            return;
        }

        try {
            const userRef = db.collection("users").doc(userId);
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(userRef);
                const currentPoints = doc.data().points || 0;
                const newPoints = currentPoints + points;
                transaction.update(userRef, { points: newPoints });

                await db.collection("history").add({
                    userId: userId,
                    username: username,
                    type: "added_by_admin",
                    amount: points,
                    newBalance: newPoints,
                    adminUser: currentUser.username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await sendNotification(userId, `تم إضافة ${points} نقطة إلى رصيدك من قبل المسؤول. رصيدك الجديد: ${newPoints}.`, "points_added");
            });
            alert(`تم إضافة ${points} نقطة للمستخدم ${username}.`);
            loadAdminUsers(); // Reload list to show updated points
        } catch (error) {
            console.error("Error adding points by admin:", error);
            alert(`فشل إضافة النقاط: ${error.message}`);
        }
    }

    async function adminDeductPointsFromUser(userId, username) {
        const pointsInput = document.getElementById(`points_${userId}`);
        const points = parseInt(pointsInput.value);

        if (isNaN(points) || points <= 0) {
            alert("يرجى إدخال عدد نقاط موجب صحيح للخصم.");
            return;
        }

        if (!confirm(`هل أنت متأكد من خصم ${points} نقطة من المستخدم ${username}؟`)) {
            return;
        }

        try {
            const userRef = db.collection("users").doc(userId);
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(userRef);
                const currentPoints = doc.data().points || 0;
                const newPoints = currentPoints - points;
                transaction.update(userRef, { points: newPoints });

                await db.collection("history").add({
                    userId: userId,
                    username: username,
                    type: "deducted_by_admin",
                    amount: points,
                    newBalance: newPoints,
                    adminUser: currentUser.username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await sendNotification(userId, `تم خصم ${points} نقطة من رصيدك من قبل المسؤول. رصيدك الجديد: ${newPoints}.`, "points_deducted");
            });
            alert(`تم خصم ${points} نقطة من المستخدم ${username}.`);
            loadAdminUsers(); // Reload list to show updated points
        } catch (error) {
            console.error("Error deducting points by admin:", error);
            alert(`فشل خصم النقاط: ${error.message}`);
        }
    }

    async function toggleAdminStatus(userId, isAdmin) {
        if (!confirm(`هل أنت متأكد من ${isAdmin ? 'تعيين' : 'إزالة'} صلاحية المسؤول للمستخدم؟`)) {
            loadAdminUsers(); // Reload to revert checkbox state if cancelled
            return;
        }
        try {
            await db.collection("users").doc(userId).update({ isAdmin: isAdmin });
            alert(`تم ${isAdmin ? 'تعيين' : 'إزالة'} صلاحية المسؤول للمستخدم.`);
            loadAdminUsers(); // Reload to ensure consistent state
        } catch (error) {
            console.error("Error toggling admin status:", error);
            alert("حدث خطأ أثناء تغيير صلاحية المسؤول: " + error.message);
        }
    }

    async function deleteUser(userId, username) {
        if (!confirm(`هل أنت متأكد من حذف المستخدم ${username}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
            return;
        }
        try {
            // Delete user document from Firestore
            await db.collection("users").doc(userId).delete();

            // Optional: You might want to delete their history, tasks, etc.
            // This would require more complex batch operations or Cloud Functions.
            // For simplicity, we'll just delete the user document.

            // Delete user from Firebase Authentication
            // This requires admin SDK, typically done via Cloud Functions or a backend server
            // For a client-side app, you cannot directly delete other users' auth records.
            // If this is a real app, implement a Cloud Function for this.
            console.warn("User's Firebase Auth record NOT deleted. This should be handled via server-side code (e.g., Cloud Functions).");
            alert(`تم حذف المستخدم ${username} من قاعدة البيانات.`);
            loadAdminUsers();
        } catch (error) {
            console.error("Error deleting user:", error);
            alert("حدث خطأ أثناء حذف المستخدم: " + error.message);
        }
    }

    // Task Management
    function showTasks() {
        showSection('tasks');
        loadTasks();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function loadTasks() {
        const tasksList = document.getElementById("tasksList");
        tasksList.innerHTML = "جاري التحميل...";

        if (!currentUser) {
            tasksList.innerHTML = "يرجى تسجيل الدخول لعرض المهام.";
            return;
        }

        try {
            const snapshot = await db.collection("tasks")
                .where("assigneeId", "==", currentUser.id)
                .where("status", "==", "pending")
                .orderBy("createdAt", "desc")
                .get();

            if (snapshot.empty) {
                tasksList.innerHTML = "لا توجد مهام حالياً.";
                return;
            }

            let html = "<ul>";
            snapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString("ar-EG") : "لا يوجد";
                const timerHtml = task.dueDate ? `<div class="task-timer" id="timer_${task.id}"></div>` : '';
                html += `
                    <li>
                        <b>${task.title}</b> <span class="task-points">${task.points} نقطة</span><br>
                        ${task.description}<br>
                        تاريخ الانتهاء: ${dueDate}<br>
                        ${timerHtml}
                        <div class="task-buttons">
                            <button onclick="completeTask('${task.id}', ${task.points}, '${task.title}')" class="complete-task">إنجاز</button>
                        </div>
                    </li>
                `;
            });
            html += "</ul>";
            tasksList.innerHTML = html;

            snapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                if (task.dueDate) {
                    startCountdown(task.dueDate, `timer_${task.id}`);
                }
            });

        } catch (error) {
            console.error("Error loading tasks:", error);
            tasksList.innerHTML = "حدث خطأ أثناء تحميل المهام.";
        }
    }

    async function completeTask(taskId, points, taskTitle) {
        if (!currentUser) {
            alert("يرجى تسجيل الدخول.");
            return;
        }
        if (!confirm(`هل أنت متأكد من إنجاز مهمة "${taskTitle}" والحصول على ${points} نقطة؟`)) {
            return;
        }

        try {
            const taskRef = db.collection("tasks").doc(taskId);
            const userRef = db.collection("users").doc(currentUser.id);

            await db.runTransaction(async (transaction) => {
                const taskDoc = await transaction.get(taskRef);
                const userDoc = await transaction.get(userRef);

                if (!taskDoc.exists || taskDoc.data().status !== 'pending') {
                    throw new Error("المهمة غير موجودة أو تم إنجازها بالفعل.");
                }

                const currentPoints = userDoc.data().points || 0;
                const newPoints = currentPoints + points;

                transaction.update(taskRef, { status: "completed", completedAt: firebase.firestore.FieldValue.serverTimestamp() });
                transaction.update(userRef, { points: newPoints });

                await db.collection("history").add({
                    userId: currentUser.id,
                    username: currentUser.username,
                    type: "task_completed",
                    amount: points,
                    newBalance: newPoints,
                    taskTitle: taskTitle,
                    taskId: taskId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await sendNotification(currentUser.id, `تهانينا! لقد أنجزت مهمة "${taskTitle}" وحصلت على ${points} نقطة. رصيدك الجديد: ${newPoints}.`, "task_completed");
            });

            currentUser.points += points; // Update local currentUser object
            document.getElementById("userPoints").textContent = currentUser.points; // Update dashboard display
            alert(`تم إنجاز المهمة بنجاح! تم إضافة ${points} نقطة.`);
            loadTasks(); // Reload tasks to remove the completed one
        } catch (error) {
            console.error("Error completing task:", error);
            alert(`فشل إنجاز المهمة: ${error.message}`);
        }
    }

    function showAdminTasks() {
        showSection('adminTasks');
        loadAdminTasks();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function addTask() {
        const title = document.getElementById("taskTitle").value.trim();
        const description = document.getElementById("taskDesc").value.trim();
        const points = parseInt(document.getElementById("taskPoints").value);
        const dueDate = document.getElementById("taskDueDate").value.trim();
        const assigneeUsername = document.getElementById("taskAssignee").value.trim();

        if (!title || !description || isNaN(points) || points <= 0) {
            alert("يرجى تعبئة جميع الحقول الإلزامية (العنوان، الشرح، النقاط) بشكل صحيح.");
            return;
        }

        let assigneeId = null;
        if (assigneeUsername) {
            const snapshot = await db.collection("users").where("username", "==", assigneeUsername).get();
            if (snapshot.empty) {
                alert("المستخدم المسؤول غير موجود.");
                return;
            }
            assigneeId = snapshot.docs[0].id;
        }

        try {
            await db.collection("tasks").add({
                title,
                description,
                points,
                dueDate: dueDate || null,
                assignee: assigneeUsername || null,
                assigneeId: assigneeId,
                status: "pending",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("تم إضافة المهمة بنجاح!");
            document.getElementById("taskTitle").value = "";
            document.getElementById("taskDesc").value = "";
            document.getElementById("taskPoints").value = "";
            document.getElementById("taskDueDate").value = "";
            document.getElementById("taskAssignee").value = "";
            loadAdminTasks();
        } catch (error) {
            console.error("Error adding task:", error);
            alert("فشل إضافة المهمة: " + error.message);
        }
    }

    async function loadAdminTasks() {
        const adminTasksList = document.getElementById("adminTasksList");
        adminTasksList.innerHTML = "جاري التحميل...";

        try {
            const snapshot = await db.collection("tasks").orderBy("createdAt", "desc").get();
            if (snapshot.empty) {
                adminTasksList.innerHTML = "لا توجد مهام.";
                return;
            }

            let html = "<ul>";
            snapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString("ar-EG") : "لا يوجد";
                const statusColor = {
                    "pending": "#f39c12", // orange
                    "completed": "#27ae60", // green
                    "rejected": "#e74c3c" // red
                }[task.status] || "#34495e"; // default gray/dark blue

                html += `
                    <li>
                        <b>${task.title}</b> (${task.points} نقطة) - للمسؤول: ${task.assignee || 'غير محدد'}<br>
                        ${task.description}<br>
                        تاريخ الانتهاء: ${dueDate} - الحالة: <span style="color:${statusColor}; font-weight:bold;">${task.status === 'pending' ? 'قيد الانتظار' : task.status === 'completed' ? 'مكتملة' : 'مرفوضة'}</span>
                        <div class="task-buttons">
                            <button onclick="editTask('${task.id}')">تعديل</button>
                            <button onclick="deleteTask('${task.id}', '${task.title}')" class="danger">حذف</button>
                        </div>
                    </li>
                `;
            });
            html += "</ul>";
            adminTasksList.innerHTML = html;
        } catch (error) {
            console.error("Error loading admin tasks:", error);
            adminTasksList.innerHTML = "حدث خطأ أثناء تحميل المهام.";
        }
    }

    let currentEditingTaskId = null;

    async function editTask(taskId) {
        currentEditingTaskId = taskId;
        try {
            const taskDoc = await db.collection("tasks").doc(taskId).get();
            if (!taskDoc.exists) {
                alert("المهمة غير موجودة.");
                return;
            }
            const task = taskDoc.data();
            document.getElementById("editTaskId").value = taskId;
            document.getElementById("editTaskTitle").value = task.title;
            document.getElementById("editTaskDesc").value = task.description;
            document.getElementById("editTaskPoints").value = task.points;
            document.getElementById("editTaskDueDate").value = task.dueDate || '';
            document.getElementById("editTaskAssignee").value = task.assignee || '';
            document.getElementById("editTaskStatus").value = task.status;

            showSection('editTaskSection');
            document.getElementById('backButton').classList.remove('hidden');
        } catch (error) {
            console.error("Error fetching task for edit:", error);
            alert("حدث خطأ أثناء تحميل المهمة للتعديل: " + error.message);
        }
    }

    async function saveTaskChanges() {
        const taskId = document.getElementById("editTaskId").value;
        const title = document.getElementById("editTaskTitle").value.trim();
        const description = document.getElementById("editTaskDesc").value.trim();
        const points = parseInt(document.getElementById("editTaskPoints").value);
        const dueDate = document.getElementById("editTaskDueDate").value.trim();
        const assigneeUsername = document.getElementById("editTaskAssignee").value.trim();
        const status = document.getElementById("editTaskStatus").value;

        if (!title || !description || isNaN(points) || points <= 0) {
            alert("يرجى تعبئة جميع الحقول الإلزامية (العنوان، الشرح، النقاط) بشكل صحيح.");
            return;
        }

        let assigneeId = null;
        if (assigneeUsername) {
            const snapshot = await db.collection("users").where("username", "==", assigneeUsername).get();
            if (snapshot.empty) {
                alert("المستخدم المسؤول غير موجود.");
                return;
            }
            assigneeId = snapshot.docs[0].id;
        }

        try {
            await db.collection("tasks").doc(taskId).update({
                title,
                description,
                points,
                dueDate: dueDate || null,
                assignee: assigneeUsername || null,
                assigneeId: assigneeId,
                status,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("تم حفظ تغييرات المهمة بنجاح!");
            loadAdminTasks();
            backToAdmin(); // Go back to admin tasks list
        } catch (error) {
            console.error("Error saving task changes:", error);
            alert("فشل حفظ تغييرات المهمة: " + error.message);
        }
    }

    function cancelEditTask() {
        currentEditingTaskId = null;
        backToAdmin();
    }

    async function deleteTask(taskId, taskTitle) {
        if (!confirm(`هل أنت متأكد من حذف المهمة "${taskTitle}"؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
            return;
        }
        try {
            await db.collection("tasks").doc(taskId).delete();
            alert("تم حذف المهمة بنجاح!");
            loadAdminTasks();
        } catch (error) {
            console.error("Error deleting task:", error);
            alert("حدث خطأ أثناء حذف المهمة: " + error.message);
        }
    }

    // Password Reset Requests (Admin)
    function showAdminRequests() {
        showSection('adminRequests');
        loadAdminRequests();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function loadAdminRequests() {
        const adminRequestsList = document.getElementById("adminRequestsList");
        adminRequestsList.innerHTML = "جاري التحميل...";

        try {
            const snapshot = await db.collection("passwordResetRequests").where("status", "==", "pending").orderBy("createdAt", "desc").get();
            if (snapshot.empty) {
                adminRequestsList.innerHTML = "لا توجد طلبات إعادة تعيين كلمة مرور معلقة.";
                return;
            }

            let html = "<ul>";
            snapshot.forEach(doc => {
                const request = { id: doc.id, ...doc.data() };
                const date = request.createdAt ? new Date(request.createdAt.toDate()).toLocaleString("ar-EG") : "تاريخ غير متوفر";
                html += `
                    <li>
                        <b>${request.username}</b> (${request.email}) طلب إعادة تعيين كلمة المرور.<br>
                        تاريخ الطلب: ${date}
                        <div class="request-buttons">
                            <button onclick="approvePasswordReset('${request.id}', '${request.userId}', '${request.username}', '${request.email}')" class="success">موافقة</button>
                            <button onclick="rejectPasswordReset('${request.id}', '${request.userId}', '${request.username}')" class="danger">رفض</button>
                        </div>
                    </li>
                `;
            });
            html += "</ul>";
            adminRequestsList.innerHTML = html;
        } catch (error) {
            console.error("Error loading admin requests:", error);
            adminRequestsList.innerHTML = "حدث خطأ أثناء تحميل الطلبات.";
        }
    }

    async function approvePasswordReset(requestId, userId, username, email) {
        if (!confirm(`هل أنت متأكد من الموافقة على طلب إعادة تعيين كلمة المرور للمستخدم ${username}؟`)) {
            return;
        }

        try {
            const resetCode = Math.random().toString(36).substring(2, 8).toUpperCase(); // Generate a random 6-char code

            await db.collection("passwordResetRequests").doc(requestId).update({
                status: "approved",
                resetCode: resetCode,
                approvedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Send notification to the user with the reset code
            await sendNotification(userId, `تمت الموافقة على طلب إعادة تعيين كلمة المرور الخاص بك. كود إعادة التعيين هو: <b>${resetCode}</b>. استخدم هذا الكود لتعيين كلمة مرور جديدة.`, "password_reset_approved");

            alert(`تمت الموافقة على الطلب وإرسال كود إعادة التعيين (${resetCode}) إلى المستخدم ${username}.`);
            loadAdminRequests();
        } catch (error) {
            console.error("Error approving password reset:", error);
            alert("فشل الموافقة على طلب إعادة تعيين كلمة المرور: " + error.message);
        }
    }

    async function rejectPasswordReset(requestId, userId, username) {
        if (!confirm(`هل أنت متأكد من رفض طلب إعادة تعيين كلمة المرور للمستخدم ${username}؟`)) {
            return;
        }

        try {
            await db.collection("passwordResetRequests").doc(requestId).update({
                status: "rejected",
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await sendNotification(userId, `تم رفض طلب إعادة تعيين كلمة المرور الخاص بك. يرجى التواصل مع المسؤول لمزيد من التفاصيل.`, "password_reset_rejected");

            alert(`تم رفض طلب إعادة تعيين كلمة المرور للمستخدم ${username}.`);
            loadAdminRequests();
        } catch (error) {
            console.error("Error rejecting password reset:", error);
            alert("فشل رفض طلب إعادة تعيين كلمة المرور: " + error.message);
        }
    }

    // Forgot Password (User Side)
    async function resetPassword() {
        const email = document.getElementById("forgotEmail").value.trim();
        const forgotError = document.getElementById("forgotError");
        const forgotSuccess = document.getElementById("forgotSuccess");

        forgotError.textContent = "";
        forgotSuccess.textContent = "";

        if (!email) {
            forgotError.textContent = "البريد الإلكتروني مطلوب.";
            return;
        }

        try {
            const userSnapshot = await db.collection("users").where("email", "==", email).get();
            if (userSnapshot.empty) {
                forgotError.textContent = "لا يوجد حساب بهذا البريد الإلكتروني.";
                return;
            }
            const user = userSnapshot.docs[0].data();
            const userId = userSnapshot.docs[0].id;
            const username = user.username;

            // Check for existing pending request
            const existingRequest = await db.collection("passwordResetRequests")
                .where("userId", "==", userId)
                .where("status", "==", "pending")
                .get();

            if (!existingRequest.empty) {
                forgotSuccess.textContent = "لديك بالفعل طلب إعادة تعيين كلمة مرور معلق. يرجى انتظار رد المسؤول.";
                document.getElementById('forgotEmailSection').classList.add('hidden');
                document.getElementById('forgotCodeSection').classList.remove('hidden');
                return;
            }

            await db.collection("passwordResetRequests").add({
                userId,
                username,
                email,
                status: "pending",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            forgotSuccess.textContent = "تم إرسال طلب إعادة تعيين كلمة المرور للمسؤول. يرجى الانتظار للحصول على كود إعادة التعيين.";
            document.getElementById('forgotEmailSection').classList.add('hidden');
            document.getElementById('forgotCodeSection').classList.remove('hidden');

            // Send admin notification
            await sendAdminNotification(`طلب إعادة تعيين كلمة مرور جديد من: ${username} (${email})`);

        } catch (error) {
            console.error("Error requesting password reset:", error);
            forgotError.textContent = `فشل إرسال الطلب: ${error.message}`;
        }
    }

    async function verifyForgotPasswordCode() {
        const email = document.getElementById("forgotEmail").value.trim();
        const code = document.getElementById("forgotCode").value.trim().toUpperCase();
        const forgotCodeError = document.getElementById("forgotCodeError");

        forgotCodeError.textContent = "";

        if (!email || !code) {
            forgotCodeError.textContent = "البريد الإلكتروني والكود مطلوبان.";
            return;
        }

        try {
            const userSnapshot = await db.collection("users").where("email", "==", email).get();
            if (userSnapshot.empty) {
                forgotCodeError.textContent = "لا يوجد حساب بهذا البريد الإلكتروني.";
                return;
            }
            const userId = userSnapshot.docs[0].id;

            const requestSnapshot = await db.collection("passwordResetRequests")
                .where("userId", "==", userId)
                .where("status", "==", "approved")
                .where("resetCode", "==", code)
                .orderBy("approvedAt", "desc") // Get the latest approved request
                .limit(1)
                .get();

            if (requestSnapshot.empty) {
                forgotCodeError.textContent = "الكود غير صحيح أو منتهي الصلاحية.";
                return;
            }

            // Mark the code as used (optional, but good practice to prevent reuse)
            await db.collection("passwordResetRequests").doc(requestSnapshot.docs[0].id).update({
                status: "used",
                usedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('forgotCodeSection').classList.add('hidden');
            document.getElementById('forgotNewPasswordSection').classList.remove('hidden');
            alert("تم التحقق من الكود بنجاح. يمكنك الآن تعيين كلمة مرور جديدة.");

        } catch (error) {
            console.error("Error verifying password reset code:", error);
            forgotCodeError.textContent = `فشل التحقق من الكود: ${error.message}`;
        }
    }

    async function performPasswordReset() {
        const email = document.getElementById("forgotEmail").value.trim();
        const newPassword = document.getElementById("resetNewPassword").value;
        const confirmNewPassword = document.getElementById("resetNewPasswordConfirm").value;
        const resetNewPasswordError = document.getElementById("resetNewPasswordError");
        const resetNewPasswordSuccess = document.getElementById("resetNewPasswordSuccess");

        resetNewPasswordError.textContent = "";
        resetNewPasswordSuccess.textContent = "";

        if (newPassword !== confirmNewPassword) {
            resetNewPasswordError.textContent = "كلمة المرور الجديدة وتأكيدها غير متطابقين.";
            return;
        }
        if (newPassword.length < 6) {
            resetNewPasswordError.textContent = "يجب أن تكون كلمة المرور 6 أحرف على الأقل.";
            return;
        }

        try {
            // Re-authenticate user if needed, or directly update if an admin reset (not user's own reset)
            // For a user-driven reset flow after code verification, this would typically involve:
            // 1. Getting the user's Auth UID based on email.
            // 2. Using `auth.currentUser.updatePassword(newPassword)` if user is logged in.
            // 3. Or if not logged in, using Firebase Admin SDK on a backend to set new password.
            //    Since we're doing it client-side after a code, we can assume the code grants
            //    temporary privilege or the user is somehow "authenticated" via the valid code.
            //    However, Firebase client SDK does NOT provide a direct `setPasswordByCode`
            //    function for other users.
            //
            // A common workaround for client-side password reset *without login* after a code
            // is to use `firebase.auth().sendPasswordResetEmail(email)` and let Firebase handle
            // the email link, or, if using custom codes, you'd need a Cloud Function
            // to update the password securely via Admin SDK.

            // Since the current structure implies an admin provides a code, and the user then uses it,
            // the most direct (but insecure for a real prod app) client-side way would be to
            // try to sign in with the old email and a placeholder password (if we had access to it),
            // then immediately change. This is not feasible or secure.

            // The correct, secure way for this flow is to use a Cloud Function (backend)
            // that takes the `userId` and `newPassword` (after code verification) and uses
            // Firebase Admin SDK to update the user's password.

            // For the purpose of completing the front-end flow, we'll simulate success
            // and show the next step if this were connected to a backend.
            alert("تم تغيير كلمة المرور بنجاح! (محاكاة)"); // Simulating success
            resetNewPasswordSuccess.textContent = "تم تغيير كلمة المرور بنجاح! يمكنك الآن تسجيل الدخول بالكلمة الجديدة.";
            showLogin(); // Go back to login screen
        } catch (error) {
            console.error("Error setting new password:", error);
            resetNewPasswordError.textContent = `فشل تعيين كلمة المرور الجديدة: ${error.message}`;
        }
    }

    // Notifications
    function showNotifications() {
        showSection('notifications');
        loadNotifications();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function loadNotifications() {
        const userNotificationsList = document.getElementById("userNotificationsList");
        userNotificationsList.innerHTML = "جاري التحميل...";

        if (!currentUser) {
            userNotificationsList.innerHTML = "يرجى تسجيل الدخول لعرض الإشعارات.";
            return;
        }

        try {
            const snapshot = await db.collection("notifications")
                .where("userId", "==", currentUser.id)
                .orderBy("timestamp", "desc")
                .limit(50)
                .get();

            if (snapshot.empty) {
                userNotificationsList.innerHTML = "لا توجد إشعارات.";
                return;
            }

            notifications = [];
            let html = "<ul>";
            snapshot.forEach(doc => {
                const notif = { id: doc.id, ...doc.data() };
                notifications.push(notif);
                const date = notif.timestamp ? new Date(notif.timestamp.toDate()).toLocaleString("ar-EG") : "تاريخ غير متوفر";
                let statusText = '';
                let statusClass = '';

                if (notif.type === "password_reset_approved") {
                    statusText = ' (تمت الموافقة)';
                    statusClass = 'notification-status-approved';
                } else if (notif.type === "password_reset_rejected") {
                    statusText = ' (تم الرفض)';
                    statusClass = 'notification-status-rejected';
                } else if (notif.type === "account_deletion_request") {
                    statusText = ' (طلب حذف حساب)';
                    statusClass = 'notification-status-deletion';
                } else if (notif.type === "account_deletion_approved") {
                    statusText = ' (تم قبول طلب الحذف)';
                    statusClass = 'notification-status-approved';
                } else if (notif.type === "account_deletion_rejected") {
                    statusText = ' (تم رفض طلب الحذف)';
                    statusClass = 'notification-status-rejected';
                    if (notif.reason) {
                        statusText += `: ${notif.reason}`;
                    }
                }

                html += `
                    <li>
                        ${notif.message} <span class="${statusClass}">${statusText}</span><br>
                        <small>${date}</small>
                        <button onclick="deleteNotification('${notif.id}')" class="danger" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8em;">حذف</button>
                    </li>
                `;
            });
            html += "</ul>";
            userNotificationsList.innerHTML = html;
            updateNotificationCount();
        } catch (error) {
            console.error("Error loading user notifications:", error);
            userNotificationsList.innerHTML = "حدث خطأ أثناء تحميل الإشعارات.";
        }
    }

    async function sendNotification(userId, message, type, newBalance = null) {
        try {
            await db.collection("notifications").add({
                userId,
                message,
                type,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false,
                newBalance: newBalance // Store new balance for point notifications
            });
            // Update notification count for current user if they are the recipient
            if (currentUser && currentUser.id === userId) {
                updateNotificationCount();
            }
        } catch (error) {
            console.error("Error sending notification:", error);
        }
    }

    async function deleteNotification(notificationId) {
        if (!confirm("هل أنت متأكد من حذف هذا الإشعار؟")) {
            return;
        }
        try {
            await db.collection("notifications").doc(notificationId).delete();
            loadNotifications(); // Reload notifications after deletion
        } catch (error) {
            console.error("Error deleting notification:", error);
            alert("حدث خطأ أثناء حذف الإشعار: " + error.message);
        }
    }

    async function clearAllNotifications() {
        if (!currentUser) return;
        if (!confirm("هل أنت متأكد من مسح جميع إشعاراتك؟")) {
            return;
        }

        try {
            const batch = db.batch();
            const snapshot = await db.collection("notifications").where("userId", "==", currentUser.id).get();
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            loadNotifications();
        } catch (error) {
            console.error("Error clearing all notifications:", error);
            alert("حدث خطأ أثناء مسح جميع الإشعارات: " + error.message);
        }
    }

    async function updateNotificationCount() {
        if (!currentUser) {
            document.getElementById("notificationCount").classList.add("hidden");
            return;
        }
        try {
            const snapshot = await db.collection("notifications")
                .where("userId", "==", currentUser.id)
                .where("read", "==", false)
                .get();
            const count = snapshot.size;
            const notificationCountElement = document.getElementById("notificationCount");
            if (count > 0) {
                notificationCountElement.textContent = count;
                notificationCountElement.classList.remove("hidden");
            } else {
                notificationCountElement.classList.add("hidden");
            }
        } catch (error) {
            console.error("Error updating notification count:", error);
        }
    }


    function showAdminNotifications() {
        showSection('adminNotifications');
        loadAdminNotifications();
        document.getElementById('backButton').classList.remove('hidden');
    }

    async function loadAdminNotifications() {
        const adminNotificationsList = document.getElementById("adminNotificationsList");
        adminNotificationsList.innerHTML = "جاري التحميل...";

        try {
            const snapshot = await db.collection("adminNotifications").orderBy("timestamp", "desc").get();
            if (snapshot.empty) {
                adminNotificationsList.innerHTML = "لا توجد إشعارات إدارية.";
                return;
            }

            adminNotifications = []; // Clear current admin notifications
            let html = "<ul>";
            snapshot.forEach(doc => {
                const notif = { id: doc.id, ...doc.data() };
                adminNotifications.push(notif);
                const date = notif.timestamp ? new Date(notif.timestamp.toDate()).toLocaleString("ar-EG") : "تاريخ غير متوفر";
                let actionButtons = '';
                if (notif.type === "account_deletion_request_admin" && notif.status === "pending") {
                    actionButtons = `
                        <button onclick="approveAccountDeletion('${notif.id}', '${notif.userId}', '${notif.username}')" class="success">قبول حذف</button>
                        <button onclick="rejectAccountDeletion('${notif.id}', '${notif.userId}', '${notif.username}')" class="danger">رفض حذف</button>
                    `;
                }
                const statusText = notif.status === 'pending' ? '<span style="color:#f39c12; font-weight:bold;">(قيد الانتظار)</span>' : '';

                html += `
                    <li>
                        ${notif.message} ${statusText}<br>
                        <small>${date}</small>
                        <div>
                            ${actionButtons}
                            <button onclick="deleteAdminNotification('${notif.id}')" class="danger">حذف إشعار</button>
                        </div>
                    </li>
                `;
            });
            html += "</ul>";
            adminNotificationsList.innerHTML = html;
        } catch (error) {
            console.error("Error loading admin notifications:", error);
            adminNotificationsList.innerHTML = "حدث خطأ أثناء تحميل الإشعارات الإدارية.";
        }
    }

    async function sendAdminNotification(message, type = "general", userId = null, username = null) {
        try {
            await db.collection("adminNotifications").add({
                message,
                type,
                userId, // Can be null if not specific to a user action
                username, // Can be null
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false,
                status: "pending" // For requests like account deletion
            });
            console.log("Admin notification sent:", message);
        } catch (error) {
            console.error("Error sending admin notification:", error);
        }
    }

    async function deleteAdminNotification(notificationId) {
        if (!confirm("هل أنت متأكد من حذف هذا الإشعار الإداري؟")) {
            return;
        }
        try {
            await db.collection("adminNotifications").doc(notificationId).delete();
            loadAdminNotifications();
        } catch (error) {
            console.error("Error deleting admin notification:", error);
            alert("حدث خطأ أثناء حذف الإشعار الإداري: " + error.message);
        }
    }

    // Account Deletion Request
    async function requestAccountDeletion() {
        if (!currentUser) {
            alert("يجب تسجيل الدخول لطلب حذف الحساب.");
            return;
        }
        if (!confirm("هل أنت متأكد أنك تريد طلب حذف حسابك؟ سيتم إرسال طلب للمسؤول للموافقة عليه.")) {
            return;
        }

        try {
            // Send request to Firestore to be reviewed by admin
            await db.collection("accountDeletionRequests").add({
                userId: currentUser.id,
                username: currentUser.username,
                email: currentUser.email,
                status: "pending",
                requestedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Notify admin
            await sendAdminNotification(`طلب حذف حساب جديد من المستخدم: ${currentUser.username} (${currentUser.email})`, "account_deletion_request_admin", currentUser.id, currentUser.username);

            alert("تم إرسال طلب حذف حسابك للمراجعة. ستتلقى إشعارًا بمجرد معالجة طلبك.");
        } catch (error) {
            console.error("Error requesting account deletion:", error);
            alert("فشل إرسال طلب حذف الحساب: " + error.message);
        }
    }

    async function approveAccountDeletion(notificationId, userId, username) {
        if (!confirm(`هل أنت متأكد من قبول طلب حذف حساب المستخدم ${username}؟ هذا سيؤدي إلى حذف الحساب نهائياً.`)) {
            return;
        }

        try {
            // First, update the admin notification status
            await db.collection("adminNotifications").doc(notificationId).update({
                status: "approved",
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Send notification to the user that their account deletion is approved
            await sendNotification(userId, `تمت الموافقة على طلب حذف حسابك. سيتم حذف حسابك قريباً.`, "account_deletion_approved");

            // Delete the user's Firestore document
            await db.collection("users").doc(userId).delete();

            // IMPORTANT: For a real application, you would also need to delete the user's
            // authentication record from Firebase Auth. This requires a backend (Cloud Function)
            // with Firebase Admin SDK, as client-side code cannot delete other users.
            console.warn("User's Firebase Auth record NOT deleted. This must be handled via server-side (Cloud Functions) for full deletion.");

            alert(`تم قبول طلب حذف حساب المستخدم ${username}. تم حذف بيانات المستخدم من Firestore.`);
            loadAdminNotifications(); // Reload admin notifications
        } catch (error) {
            console.error("Error approving account deletion:", error);
            alert("فشل قبول طلب حذف الحساب: " + error.message);
        }
    }

    async function rejectAccountDeletion(notificationId, userId, username) {
        const rejectionReason = prompt(`الرجاء إدخال سبب رفض طلب حذف حساب ${username} (اختياري):`);
        if (!confirm(`هل أنت متأكد من رفض طلب حذف حساب المستخدم ${username}?`)) {
            return;
        }

        try {
            // Update admin notification status
            await db.collection("adminNotifications").doc(notificationId).update({
                status: "rejected",
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Send notification to the user about the rejection
            await sendNotification(userId, `تم رفض طلب حذف حسابك. السبب: ${rejectionReason || 'لا يوجد سبب محدد.'}`, "account_deletion_rejected", null, rejectionReason);

            alert(`تم رفض طلب حذف حساب المستخدم ${username}.`);
            loadAdminNotifications(); // Reload admin notifications
        } catch (error) {
            console.error("Error rejecting account deletion:", error);
            alert("فشل رفض طلب حذف الحساب: " + error.message);
        }
    }

    // SAR Conversion
    function showAdminSARSettings() {
        showSection('adminSarSettings');
        document.getElementById('backButton').classList.remove('hidden');
        document.getElementById("newSarRate").value = sarRate; // Display current rate
        document.getElementById("convertedSarValue").textContent = "0.00 SAR";
    }

    async function updateSarRate() {
        const newRate = parseFloat(document.getElementById("newSarRate").value);
        if (isNaN(newRate) || newRate <= 0) {
            alert("يرجى إدخال سعر تحويل صحيح وموجب.");
            return;
        }
        if (!confirm(`هل أنت متأكد من تحديث سعر تحويل النقطة إلى ${newRate.toFixed(2)} SAR؟`)) {
            return;
        }
        try {
            await db.collection("settings").doc("sarConversion").set({ rate: newRate });
            sarRate = newRate;
            document.getElementById("currentSarRate").textContent = sarRate.toFixed(2);
            alert("تم تحديث سعر التحويل بنجاح!");
        } catch (error) {
            console.error("Error updating SAR rate:", error);
            alert("فشل تحديث سعر التحويل: " + error.message);
        }
    }

    async function convertPointsToSar() {
        const pointsToConvert = parseInt(document.getElementById("pointsToConvert").value);
        if (isNaN(pointsToConvert) || pointsToConvert <= 0) {
            alert("يرجى إدخال عدد نقاط صحيح وموجب للتحويل.");
            return;
        }
        if (!currentUser) {
            alert("يجب تسجيل الدخول لتحويل النقاط.");
            return;
        }
        if (currentUser.points < pointsToConvert) {
            alert("رصيدك لا يكفي لإجراء هذا التحويل.");
            return;
        }

        const sarValue = pointsToConvert * sarRate;
        if (!confirm(`هل أنت متأكد من تحويل ${pointsToConvert} نقطة إلى ${sarValue.toFixed(2)} SAR؟`)) {
            return;
        }

        try {
            const userRef = db.collection("users").doc(currentUser.id);
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                const currentPoints = userDoc.data().points || 0;
                const newPoints = currentPoints - pointsToConvert;
                transaction.update(userRef, { points: newPoints });

                await db.collection("history").add({
                    userId: currentUser.id,
                    username: currentUser.username,
                    type: "sar_converted",
                    amount: pointsToConvert,
                    sarValue: sarValue,
                    newBalance: newPoints,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            currentUser.points -= pointsToConvert;
            document.getElementById("userPoints").textContent = currentUser.points;
            document.getElementById("convertedSarValue").textContent = `${sarValue.toFixed(2)} SAR`;
            alert(`تم تحويل ${pointsToConvert} نقطة بنجاح إلى ${sarValue.toFixed(2)} SAR.`);
            document.getElementById("pointsToConvert").value = "";
        } catch (error) {
            console.error("Error converting points to SAR:", error);
            alert("فشل تحويل النقاط إلى SAR: " + error.message);
        }
    }

    // Utility functions
    function togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        const icon = input.nextElementSibling.querySelector('i');
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function goBack() {
        // This function will intelligently go back to the previous logical section
        const currentSection = document.querySelector('.container > div:not(.hidden)');
        if (currentSection) {
            switch (currentSection.id) {
                case 'signup':
                case 'login':
                case 'forgotPassword':
                    showMain();
                    break;
                case 'dashboard':
                    // If on dashboard, and not logged in, go to main
                    // If logged in, dashboard is the 'home', so back button could hide or be removed
                    // For now, let's make it hide only if coming from initial login/signup
                    if (!currentUser) showMain();
                    else document.getElementById('backButton').classList.add('hidden');
                    break;
                case 'adminSection':
                    showDashboard();
                    break;
                case 'addPoints':
                case 'transferPoints':
                case 'adminUsers':
                case 'adminTasks':
                case 'adminRequests':
                case 'adminNotifications':
                case 'adminSarSettings':
                case 'violationsAdmin': // Added
                case 'loanSection': // Added
                    showAdminSection();
                    break;
                case 'tasks':
                case 'history':
                case 'notifications':
                case 'violationsUser': // Added
                    showDashboard();
                    break;
                case 'editTaskSection':
                    showAdminTasks();
                    break;
                default:
                    showMain(); // Fallback
            }
        } else {
            showMain(); // If no section visible, go to main
        }
    }

    function startCountdown(dueDateString, elementId) {
        const countdownElement = document.getElementById(elementId);
        if (!countdownElement) return;

        const endDate = new Date(dueDateString);

        const updateCountdown = setInterval(() => {
            const now = new Date().getTime();
            const distance = endDate.getTime() - now;

            if (distance < 0) {
                clearInterval(updateCountdown);
                countdownElement.innerHTML = "انتهى الوقت!";
                countdownElement.style.color = "#e74c3c";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownElement.innerHTML = `تبقى: ${days} يوم ${hours} ساعة ${minutes} دقيقة ${seconds} ثانية`;
        }, 1000);
    }
    
    function showViolationsAdmin() {
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("violationsAdmin").style.display = "block";
  loadViolationsAdmin();
}

function showViolationsUser() {
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("violationsUser").style.display = "block";
  loadViolationsUser();
}

function backToDashboard() {
  document.getElementById("violationsAdmin").style.display = "none";
  document.getElementById("violationsUser").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
}

function addViolation() {
  const user = document.getElementById("violationUser").value.trim();
  const title = document.getElementById("violationTitle").value.trim();
  const desc = document.getElementById("violationDesc").value.trim();
  const points = parseInt(document.getElementById("violationPoints").value);
  const due = document.getElementById("violationDue").value.trim();

  if (!user || !title || !desc || isNaN(points)) {
    alert("يرجى تعبئة جميع الحقول");
    return;
  }

  db.collection("users").where("username", "==", user).get()
    .then(snapshot => {
      if (snapshot.empty) return alert("المستخدم غير موجود");

      const userId = snapshot.docs[0].id;
      return db.collection("violations").add({
        userId, user, title, desc, points, due, paid: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    })
    .then(() => loadViolationsAdmin());
}

function loadViolationsAdmin() {
  const container = document.getElementById("violationListAdmin");
  container.innerHTML = "جاري التحميل...";

  db.collection("violations").orderBy("createdAt", "desc").get().then(snapshot => {
    if (snapshot.empty) return container.innerHTML = "لا توجد مخالفات";

    container.innerHTML = "";
    snapshot.forEach(doc => {
      const v = doc.data();
      const div = document.createElement("div");
      div.innerHTML = `<b>${v.user}</b> - ${v.title} (${v.points} نقطة) <br>${v.desc}<br><button onclick="deductPoints('${doc.id}', '${v.user}', ${v.points})">سحب القيمة</button><hr>`;
      container.appendChild(div);
    });
  });
}

function deductPoints(violationId, username, points) {
  db.collection("users").where("username", "==", username).get().then(snapshot => {
    if (snapshot.empty) return alert("المستخدم غير موجود");
    const userDoc = snapshot.docs[0];
    const newPoints = (userDoc.data().points || 0) - points;
    const userRef = db.collection("users").doc(userDoc.id);
    return db.runTransaction(tx => {
      tx.update(userRef, { points: newPoints });
      tx.update(db.collection("violations").doc(violationId), { paid: true });
    }).then(() => loadViolationsAdmin());
  });
}

function loadViolationsUser() {
  const container = document.getElementById("violationListUser");
  container.innerHTML = "جاري التحميل...";
  const uid = auth.currentUser.uid;

  db.collection("violations").where("userId", "==", uid).where("paid", "==", false).get()
    .then(snapshot => {
      if (snapshot.empty) {
        container.innerHTML = "لا يوجد مخالفات مسجلة";
        return;
      }
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const v = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `<b>${v.title}</b> - ${v.points} نقطة<br>${v.desc}<br>المدة: ${v.due}<br><button onclick="payViolation('${doc.id}', ${v.points})">سداد</button><hr>`;
        container.appendChild(div);
      });
    });
}

function payViolation(violationId, points) {
  const uid = auth.currentUser.uid;
  const userRef = db.collection("users").doc(uid);

  db.runTransaction(async tx => {
    const userSnap = await tx.get(userRef);
    const currentPoints = userSnap.data().points || 0;
    if (currentPoints < points) throw new Error("رصيدك لا يكفي");

    tx.update(userRef, { points: currentPoints - points });
    tx.update(db.collection("violations").doc(violationId), { paid: true });
  }).then(() => loadViolationsUser()).catch(err => alert(err.message));
}


function showLoan() {
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("loanSection").style.display = "block";
  loadLoanRequests();
}

function sendLoanRequest() {
  const fromUser = document.getElementById("loanFrom").value.trim();
  const amount = parseInt(document.getElementById("loanAmount").value);

  if (!fromUser || isNaN(amount) || amount <= 0) {
    alert("يرجى إدخال البيانات بشكل صحيح");
    return;
  }

  db.collection("users").where("username", "==", fromUser).get()
    .then(snapshot => {
      if (snapshot.empty) return alert("المستخدم غير موجود");

      const toUserId = snapshot.docs[0].id;
      const toUsername = snapshot.docs[0].data().username;
      return db.collection("loans").add({
        from: toUserId,
        fromUsername: toUsername,
        to: auth.currentUser.uid,
        toUsername: currentUser.username,
        amount,
        approved: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    })
    .then(() => alert("تم إرسال الطلب"));
}

function loadLoanRequests() {
  const box = document.getElementById("loanRequests");
  box.innerHTML = "جاري التحميل...";

  db.collection("loans").where("from", "==", auth.currentUser.uid).where("approved", "==", null).get()
    .then(snapshot => {
      if (snapshot.empty) {
        box.innerHTML = "لا يوجد طلبات جديدة";
        return;
      }

      box.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `طلب من <b>${d.toUsername}</b> بمقدار ${d.amount} نقطة<br>
          <button onclick="respondLoan('${doc.id}', true, ${d.amount}, '${d.to}')">موافقة</button>
          <button onclick="respondLoan('${doc.id}', false)">رفض</button><hr>`;
        box.appendChild(div);
      });
    });
}

function respondLoan(loanId, approve, amount = 0, toUserId = "") {
  const fromUserId = auth.currentUser.uid;
  const fromRef = db.collection("users").doc(fromUserId);
  const toRef = db.collection("users").doc(toUserId);
  const loanRef = db.collection("loans").doc(loanId);

  if (!approve) {
    loanRef.update({ approved: false }).then(() => loadLoanRequests());
    return;
  }

  db.runTransaction(async tx => {
    const fromSnap = await tx.get(fromRef);
    const toSnap = await tx.get(toRef);
    const fromPoints = fromSnap.data().points || 0;
    const toPoints = toSnap.data().points || 0;

    if (fromPoints < amount) throw new Error("لا يوجد نقاط كافية");

    tx.update(fromRef, { points: fromPoints - amount });
    tx.update(toRef, { points: toPoints + amount });
    tx.update(loanRef, { approved: true });
  }).then(() => loadLoanRequests()).catch(err => alert(err.message));
}

function openCustomerServiceModal() {
    document.getElementById('customerServiceModal').classList.add('show');
}

function closeCustomerServiceModal() {
    document.getElementById('customerServiceModal').classList.remove('show');
}

function copyPhoneNumber(phoneNumber) {
    navigator.clipboard.writeText(phoneNumber).then(() => {
        alert('تم نسخ رقم الهاتف!');
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

</script>
</body>
</html>
